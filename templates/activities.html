<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Dashboard - Pomonotes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="/static/manifest.json">
    <!-- Add auth.js script -->
    <script src="/static/auth.js"></script>
    <script src="/static/navbar.js"></script>
</head>

<body>
    <div id="navbar-placeholder"></div>
    <main class="container">
        <div class="app-layout activities-layout">
            <div class="activity-header">
                <article>
                    <h1>Activity Dashboard</h1>
                    <p>View your productivity patterns over time</p>
                </article>
            </div>

            <div class="weekly-chart-section">
                <article>
                    <header>
                        <h2>Weekly Activity</h2>
                        <p>Minutes spent in focused work each day</p>
                    </header>
                    <canvas id="weekly-chart"></canvas>
                </article>
            </div>

            <div class="heatmap-section">
                <article>
                    <header>
                        <h2>Activity History</h2>
                        <p>Your productivity heatmap over the past 6 months</p>
                    </header>

                    <div class="heatmap-scroll-wrapper">
                        <div class="heatmap-inner">
                            <div class="month-labels" id="monthLabels"></div>

                            <div class="heatmap-wrapper">
                                <div class="day-labels">
                                    <div>Mon</div>
                                    <div>Tue</div>
                                    <div>Wed</div>
                                    <div>Thu</div>
                                    <div>Fri</div>
                                    <div>Sat</div>
                                    <div>Sun</div>
                                </div>

                                <div class="heatmap" id="heatmap"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tooltip" id="tooltip"></div>
                </article>
            </div>
        </div>
    </main>

    <script>
        // Load the heatmap and weekly chart functions from script.js
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize heatmap
            if (typeof initHeatmap === 'function') {
                initHeatmap();
            } else {
                // If the function isn't available yet, we'll include it directly
                initHeatmap();
            }

            // Initialize the weekly chart
            initWeeklyChart();

            // Initialize heatmap function (copied from script.js)
            function initHeatmap() {
                const heatmap = document.getElementById("heatmap");
                const monthLabels = document.getElementById("monthLabels");
                const tooltip = document.getElementById("tooltip");

                if (!heatmap || !monthLabels) return; // Exit if elements don't exist

                // Clear existing content
                heatmap.innerHTML = '';
                monthLabels.innerHTML = '';

                // Add a spacer for alignment
                const spacer = document.createElement("div");
                spacer.innerHTML = "&nbsp;";
                monthLabels.appendChild(spacer);

                const MS_PER_DAY = 24 * 60 * 60 * 1000;
                const DAYS_IN_WEEK = 7;
                const WEEKS_TO_SHOW = 26; // ~6 months

                // Get dates for the past ~6 months
                const today = new Date();
                const startDate = new Date();
                startDate.setDate(today.getDate() - DAYS_IN_WEEK * WEEKS_TO_SHOW);

                // Fetch session data from API
                fetch('/api/sessions')
                    .then(response => response.json())
                    .then(sessions => {
                        // Create a map of dates to activity levels
                        const activityMap = {};

                        // Process all sessions
                        sessions.forEach(session => {
                            const sessionDate = new Date(session.start_time);
                            // Convert to YYYY-MM-DD format for map key
                            const dateKey = sessionDate.toISOString().split('T')[0];

                            // Calculate minutes for this session
                            const minutes = Math.round(session.total_time / 60);

                            // Add to existing count or initialize
                            if (activityMap[dateKey]) {
                                activityMap[dateKey] += minutes;
                            } else {
                                activityMap[dateKey] = minutes;
                            }
                        });

                        // Add today's sample activity

                        // Build the heatmap with actual data
                        buildHeatmap(startDate, today, activityMap, heatmap, monthLabels, tooltip);
                    })
                    .catch(error => {
                        console.error('Error loading sessions for heatmap:', error);

                        // Even with an error, still add today's sample
                        const activityMap = {};

                        // Build heatmap with at least today's data
                        buildHeatmap(startDate, today, activityMap, heatmap, monthLabels, tooltip);
                    });
            }

            // Build the heatmap with the given data
            function buildHeatmap(startDate, endDate, activityMap, heatmap, monthLabels, tooltip) {
                // Group dates by week
                const dates = [];
                let current = new Date(startDate);

                while (current <= endDate) {
                    dates.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }

                const weeks = [];
                let week = [];

                // First, align to the start of the week (Monday is 1, Sunday is 0)
                const firstDay = dates[0].getDay();
                const daysToAdd = firstDay === 0 ? 6 : firstDay - 1; // Convert to Monday-based week

                // Add empty days at the beginning to align with week
                for (let i = 0; i < daysToAdd; i++) {
                    week.push(null);
                }

                // Group dates into weeks
                for (let i = 0; i < dates.length; i++) {
                    const date = dates[i];
                    const day = date.getDay();

                    // If it's a new week (Monday) and we have dates in the current week
                    if (day === 1 && week.length > 0) {
                        weeks.push(week);
                        week = [];
                    }

                    week.push(date);

                    // If we're at the end, add the final week
                    if (i === dates.length - 1) {
                        // Fill in any missing days at the end of the week
                        const missingDays = 7 - week.length;
                        for (let j = 0; j < missingDays; j++) {
                            week.push(null);
                        }
                        weeks.push(week);
                    }
                }

                // Add month labels
                const visibleMonths = new Set();
                const monthPositions = {};

                // First identify which months are visible and their positions
                weeks.forEach((weekDates, weekIndex) => {
                    weekDates.forEach(date => {
                        if (date) {
                            const month = date.getMonth();
                            const day = date.getDate();

                            // Only register the first day of each month
                            if (day === 1) {
                                visibleMonths.add(month);
                                monthPositions[month] = weekIndex;
                            }
                        }
                    });
                });

                // Now add labels only for visible months, at their correct positions
                // Add spacer divs for each week
                weeks.forEach((_, weekIndex) => {
                    const label = document.createElement("div");

                    // Check if any month starts in this week
                    let found = false;
                    for (const [month, position] of Object.entries(monthPositions)) {
                        if (parseInt(position) === weekIndex) {
                            const monthName = new Date(2000, parseInt(month), 1).toLocaleString('default', {month: 'short'});
                            label.innerText = monthName;
                            found = true;
                            break;
                        }
                    }

                    if (!found) {
                        label.innerHTML = "&nbsp;";
                    }

                    monthLabels.appendChild(label);
                });

                // Build heatmap cells
                weeks.forEach(weekDates => {
                    const weekEl = document.createElement("div");
                    weekEl.classList.add("week");

                    // Loop through each day of the week (Monday=0, Sunday=6 in our layout)
                    for (let i = 0; i < 7; i++) {
                        const date = weekDates[i];
                        const dayEl = document.createElement("div");
                        dayEl.classList.add("day");

                        if (date) {
                            // Get activity level for this day
                            const dateKey = date.toISOString().split('T')[0];
                            const minutesWorked = activityMap[dateKey] || 0;

                            // Determine level based on minutes worked
                            // Level 0: 0 minutes (empty)
                            // Level 1: 1-30 minutes
                            // Level 2: 31-60 minutes
                            // Level 3: 61-120 minutes
                            // Level 4: 120+ minutes
                            let level = 0;
                            if (minutesWorked > 0) {
                                if (minutesWorked <= 30) level = 1;
                                else if (minutesWorked <= 60) level = 2;
                                else if (minutesWorked <= 120) level = 3;
                                else level = 4;
                            }

                            if (level > 0) {
                                dayEl.classList.add(`level-${level}`);
                            }

                            // Format date for tooltip
                            const formattedDate = date.toLocaleDateString();
                            dayEl.dataset.tooltip = `${minutesWorked} minutes on ${formattedDate}`;

                            // Highlight today with special styling
                            const todayStr = new Date().toISOString().split('T')[0];
                            if (dateKey === todayStr) {
                                dayEl.classList.add('today');
                            }
                        }

                        weekEl.appendChild(dayEl);
                    }

                    heatmap.appendChild(weekEl);
                });

                // Tooltip functionality
                heatmap.addEventListener("mouseover", (e) => {
                    if (e.target.classList.contains("day") && e.target.dataset.tooltip) {
                        tooltip.innerText = e.target.dataset.tooltip;
                        tooltip.style.opacity = 1;
                    }
                });

                heatmap.addEventListener("mousemove", (e) => {
                    tooltip.style.left = e.pageX + 10 + "px";
                    tooltip.style.top = e.pageY - 20 + "px";
                });

                heatmap.addEventListener("mouseout", () => {
                    tooltip.style.opacity = 0;
                });
            }

            // Weekly chart initialization
            function initWeeklyChart() {
                fetch("/api/sessions")
                    .then((response) => response.json())
                    .then((sessions) => {
                        // Process data for the last 7 days
                        const days = [];
                        const dailyDurations = [];

                        // Get dates for the last 7 days
                        for (let i = 6; i >= 0; i--) {
                            const date = new Date();
                            date.setDate(date.getDate() - i);
                            days.push(date.toLocaleDateString("en-US", {weekday: "short"}));
                            dailyDurations.push(0); // Initialize with 0 minutes
                        }

                        // Calculate duration for each day
                        if (sessions && sessions.length > 0) {
                            sessions.forEach((session) => {
                                const sessionDate = new Date(session.start_time);
                                const today = new Date();

                                // Check if session is within the last 7 days
                                const diffTime = Math.abs(today - sessionDate);
                                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                                if (diffDays < 7) {
                                    const dayIndex = 6 - diffDays;
                                    dailyDurations[dayIndex] += session.total_time / 60; // Convert seconds to minutes
                                }
                            });
                        }

                        // Create the chart
                        const ctx = document.getElementById("weekly-chart").getContext("2d");
                        new Chart(ctx, {
                            type: "bar",
                            data: {
                                labels: days,
                                datasets: [
                                    {
                                        label: "Minutes",
                                        data: dailyDurations,
                                        backgroundColor: "rgba(231, 76, 60, 0.7)",
                                        borderColor: "rgba(231, 76, 60, 1)",
                                        borderWidth: 1,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: "Minutes",
                                        },
                                    },
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: "Daily Pomodoro Minutes",
                                    },
                                    legend: {
                                        display: false,
                                    },
                                },
                            },
                        });
                    })
                    .catch((error) =>
                        console.error("Error loading sessions for chart:", error)
                    );
            }
        });
    </script>
</body>

</html>
